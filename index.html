<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feednly Camera Uploader</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0d1117;
      color: #e6edf3;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    #fileInput {
      display: none;
    }
    #status {
      font-size: 14px;
      color: #9db3c4;
      text-align: center;
      padding: 12px 16px;
      border-radius: 12px;
      background: #151b23;
      border: 1px solid #1f2630;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25);
      width: min(520px, 90vw);
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <input id="fileInput" type="file" accept="video/*" />
  <div id="status">Awaiting upload URL…</div>

  <script>
    (function () {
      let fileInput = document.getElementById("fileInput");
      const statusEl = document.getElementById("status");
      let uploadURL = "";
      let mode = "camera";
      let pendingFile = null;

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function notifyHost(payload) {
        try {
          const message = JSON.stringify(payload);
          if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
            window.ReactNativeWebView.postMessage(message);
          } else if (window.parent && window.parent !== window && window.parent.postMessage) {
            window.parent.postMessage(message, "*");
          }
        } catch (error) {
          console.error("postMessage failed", error);
        }
      }

      function extractAssetId(url) {
        try {
          const { pathname } = new URL(url);
          const segments = pathname.split("/").filter(Boolean);
          return segments.length ? segments[segments.length - 1].split("?")[0] : "";
        } catch (error) {
          console.warn("Unable to parse asset id", error);
          return "";
        }
      }

      function recreateInput(forGallery = false) {
        const old = document.getElementById("fileInput");
        if (old) old.remove();

        const input = document.createElement("input");
        input.id = "fileInput";
        input.type = "file";
        input.accept = "video/*";
        input.style.display = "none";

        if (!forGallery) {
          input.setAttribute("capture", "environment");
          input.capture = "environment";
        }

        input.addEventListener("change", handleFileSelect);

        document.body.appendChild(input);
        fileInput = input;
        return input;
      }

      function openPicker() {
        const input = recreateInput(mode === "gallery");
        input.value = "";
        input.click();
      }

      function handleError(message) {
        console.error(message);
        setStatus(message);
        notifyHost({ status: "error", error: message });
      }

      function uploadFile(file) {
        if (!uploadURL) {
          pendingFile = file;
          setStatus("Video ready. Waiting for upload URL…");
          notifyHost({ status: "pending_upload_url" });
          return;
        }
        const xhr = new XMLHttpRequest();
        xhr.open("PUT", uploadURL, true);
        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            setStatus(`Uploading… ${percent}%`);
          } else {
            setStatus("Uploading…");
          }
        };
        xhr.onload = function () {
          if (xhr.status >= 200 && xhr.status < 300) {
            const assetId = extractAssetId(uploadURL);
            setStatus("Upload complete");
            notifyHost({ status: "ok", asset_id: assetId });
          } else {
            handleError(`Upload failed (${xhr.status})`);
          }
        };
        xhr.onerror = function () {
          handleError("Network error during upload");
        };
        xhr.setRequestHeader("Content-Type", file.type || "video/mp4");
        xhr.send(file);
      }

      function handleFileSelect(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          setStatus(mode === "gallery" ? "No file selected. Reopening gallery…" : "No file selected. Reopening camera…");
          openPicker();
          return;
        }
        pendingFile = null;
        setStatus(uploadURL ? "Video selected. Uploading…" : "Video selected. Waiting for upload URL…");
        uploadFile(file);
      }

      function initFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const url = params.get("uploadURL") || params.get("uploadUrl") || params.get("upload_url");
        if (url) {
          uploadURL = url;
        }
      }

      function setUploadURL(url) {
        if (url) {
          uploadURL = url;
          if (pendingFile) {
            const fileToUpload = pendingFile;
            pendingFile = null;
            setStatus("Upload URL received. Uploading video…");
            uploadFile(fileToUpload);
          } else if (!statusEl.textContent.includes("Upload complete")) {
            setStatus(mode === "gallery" ? "Gallery ready. Select a video." : "Camera ready. Record a video.");
          }
        }
      }

      function start(selectedMode = "camera", url = "") {
        mode = selectedMode === "gallery" ? "gallery" : "camera";
        setUploadURL(url);
        initFromQuery();
        setStatus(
          uploadURL
            ? mode === "gallery"
              ? "Opening video gallery…"
              : "Opening video camera…"
            : mode === "gallery"
              ? "Opening gallery. Upload will start once a URL is provided…"
              : "Opening camera. Upload will start once a URL is provided…"
        );
        openPicker();
      }

      window.feednlyStart = start;
      window.feednlySetUploadURL = setUploadURL;

      document.addEventListener("DOMContentLoaded", () => {
        initFromQuery();
        recreateInput(true);
        if (uploadURL) {
          setStatus("Ready. Call feednlyStart('camera'|'gallery', uploadURL) to begin.");
        } else {
          setStatus("Awaiting upload URL…");
        }
      });
    })();
  </script>
</body>
</html>
